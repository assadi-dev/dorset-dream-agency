name: Deploy

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Setup Redis
              uses: shogo82148/actions-setup-redis@v1
              with:
                redis-version: "8.x"

            - name: Add Redis to PATH
              run: echo "/opt/hostedtoolcache/redis/*/x64/bin" >> $GITHUB_PATH

            - name: Start Redis server (TCP mode)
              run: redis-server --port 6379 --daemonize yes
        
            - name: Check Redis is up
              run: redis-cli -h 127.0.0.1 -p 6379 ping
        
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Run build
              run: npm i && npm run build

            # D√©ploiement vers le serveur en SSH
            - name: Set up SSH key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{secrets.SERVER_IP}} >> ~/.ssh/known_hosts

            - name: Run deploy.sh on remote server
              run: ssh  ${{secrets.SSH_HOST}} "cd /var/www/dorset-dream-agency && ./deploy.sh"

            # Notification de l'execution des job vers Discord

            - name: Discord notification on success
              if: success()
              run: |
                  curl -s -o /dev/null -w "%{http_code}" -H "Content-type: application/json" \
                  -X POST \
                  -d '{"content": "‚úÖ D√©ploiement r√©ussi sur `main`"}' \
                  ${{secrets.DISCORD_WEBHOOK_SUCCESS_URL}}
            - name: Discord notification on failure
              if: failure()
              run: |
                  curl -s -o /dev/null -w   -H "Content-type: application/json" \
                  -X POST \
                  -d '"{\"content\": \"‚ùå D√©ploiement **√©chou√©** sur \`main\`\nüîó [Voir le job](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}" \
                  ${{secrets.DISCORD_WEBHOOK_FAIL_URL}}
